name: CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Configure kubectl (for kind/minikube)
      run: |
        # For local Kubernetes (kind/minikube), you would configure kubeconfig here
        # This is a placeholder - adjust based on your Kubernetes setup
        echo "Configure kubectl based on your environment"
        # Example for kind:
        # mkdir -p $HOME/.kube
        # kind get kubeconfig > $HOME/.kube/config
    
    - name: Deploy to Kubernetes
      run: |
        # Update image tag in deployment
        sed -i "s|image: cats-dogs-classifier:latest|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}|g" \
          deployment/kubernetes/deployment.yaml
        
        # Apply Kubernetes manifests
        kubectl apply -f deployment/kubernetes/deployment.yaml
    
    - name: Wait for deployment
      run: |
        kubectl rollout status deployment/cats-dogs-classifier -n default --timeout=5m
    
    - name: Run smoke tests
      run: |
        # Get service endpoint
        SERVICE_IP=$(kubectl get service cats-dogs-classifier-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        SERVICE_PORT=$(kubectl get service cats-dogs-classifier-service -o jsonpath='{.spec.ports[0].port}')
        
        if [ -z "$SERVICE_IP" ]; then
          # For local clusters, use port-forward
          kubectl port-forward service/cats-dogs-classifier-service 8000:80 &
          sleep 5
          SERVICE_URL="http://localhost:8000"
        else
          SERVICE_URL="http://${SERVICE_IP}:${SERVICE_PORT}"
        fi
        
        # Run smoke tests
        chmod +x scripts/smoke_tests.sh
        ./scripts/smoke_tests.sh $SERVICE_URL

  deploy-docker-compose:
    name: Deploy with Docker Compose
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Pull latest image
      run: |
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} || \
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
    
    - name: Tag image for local use
      run: |
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} cats-dogs-classifier:latest || \
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main cats-dogs-classifier:latest
    
    - name: Deploy with Docker Compose
      run: |
        cd deployment/docker-compose
        docker-compose up -d
    
    - name: Wait for service
      run: |
        sleep 10
        timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'
    
    - name: Run smoke tests
      run: |
        chmod +x scripts/smoke_tests.sh
        ./scripts/smoke_tests.sh http://localhost:8000

